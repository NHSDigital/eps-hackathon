# EPS API Hackathon Setup


## Introduction
The following document will provide a working guide on the setup required before attending the Hackathon, including information on:
* Setting up an NHSD Developer Account
* Creating an API application
* Creating a client server (optional)
* Setup Auth in Postman
* Sending an example message


The intention is to provide a guide on initial setup with the NHSD API platform and send an initial message using the development tool Postman.


The Electronic Prescription Service - FHIR API documentation can be found here: 

        https://digital.nhs.uk/developer/api-catalogue/electronic-prescription-service-fhir


You can find information about both prescribing and dispensing endpoints as well as information on how to sign prescriptions using the Signing Service API.


The Signing Service API documentation can be found here: 

        https://digital.nhs.uk/developer/api-catalogue/signing-service


This guide doesn’t cover integrating with the signing service, however it is part of integrating with the wider EPS for prescribing so is included here for reference. 
        
 








## Make a Developer Account
 
Step one is to create an NHSD developer account. This is the same as creating an account with any online service. Enter an email address and password, then follow the link in your confirmation email.


Follow Step 2 of this page:

[Getting started with NHS Digital APIs](https://digital.nhs.uk/developer/getting-started)




## Create an Application
 
You will need to register a user-restricted app on our platform. This is done by logging into the developer portal with the account created in step 1 and choosing My Applications - New App.

Developer Portal:

         https://portal.developer.nhs.uk/


This process is outlined by the tutorial “Creating an application” here:

 [User-restricted REST API tutorial](https://digital.nhs.uk/developer/guides-and-documentation/tutorials/user-restricted-rest-api-tutorial)


This will supply your App ID, API Key, and Secret.
![App ID, Key and Secret](/eps-hackathon/assets/image5.jpg)







When making a new app, enable Electronic Prescription Service - integration testing environment.
![Enable EPS](/eps-hackathon/assets/image7.jpg)  





Optionally enable Signing Service - integration testing environment. This will not be used for this walkthrough but could be useful for more advanced development.
  







The API uses OAuth 2.0 authorisation and will need a callback URL. For the purposes of this guide we will use a Postman callback URL:

https://oauth.pstmn.io/v1/browser-callback
  



If you are creating your own client server (Optional next step), provide your own callback URL.


Save your app. 












 
## (Optional) Create a client server
 
This is an optional step in order to develop software against our API rather than using Postman. This is out of scope for this guide but a brief example using the platform’s Hello World API can be adapted for use with EPS: 
User-restricted REST API tutorial
 




## Setup Postman Auth

In order to send a message to the EPS FHIR API using Postman, it’s necessary to setup the Authorization parameters in the correct way to use OAuth 2.0.


 
  
  

 








































## Send a Message

The first step in the Prescribing workflow is to prepare a prescription for signing. We will hit this endpoint using Postman in order to test that our app and authorization is set up correctly. 
 


### POST to:

https://int.api.service.nhs.uk/electronic-prescriptions/FHIR/R4/$prepare
 


### Headers

```
Accept: application/fhir+json
Content-Type: application/fhir+json
X-Request-Id: {{$guid}}
```

Note: The X-Request-Id is generated by Postman
 
  







### Body

This is an example FHIR bundle resource that contains the following resources required to form a prescription:

* MessageHeader
* MedicationRequest
* Patient
* PractitionerRole
* Practitioner
* Organization






Message:
```json
{
  "resourceType": "Bundle",
  "id": "0cb82cfa-76c8-4fb2-a08e-bf0e326e5487",
  "identifier": {
        "system": "https://tools.ietf.org/html/rfc4122",
        "value": "c61caa47-05bd-4998-adb2-b907ae45fb12"
  },
  "type": "message",
  "entry": [
        {
          "fullUrl": "urn:uuid:17773b27-427e-4940-8c16-64cdac715001",
          "resource": {
            "resourceType": "MessageHeader",
            "eventCoding": {
              "system": "https://fhir.nhs.uk/CodeSystem/message-event",
              "code": "prescription-order",
              "display": "Prescription Order"
            },
            "sender": {
              "identifier": {
                "system": "https://fhir.nhs.uk/Id/ods-organization-code",
                "value": "A83008"
              },
              "display": "HALLGARTH SURGERY"
            },
            "source": {
              "endpoint": "urn:nhs-uk:addressing:ods:A83008"
            },
            "destination": [
              {
                "endpoint": "https://sandbox.api.service.nhs.uk/electronic-prescriptions/$post-message",
                "receiver": {
                  "identifier": {
                    "system": "https://fhir.nhs.uk/Id/ods-organization-code",
                    "value": "FCG71"
                  }
                }
              }
            ],
            "focus": [
              {
                "reference": "urn:uuid:56166769-c1c4-4d07-afa8-132b5dfca666"
              },
              {
                "reference": "urn:uuid:5cb17f5a-11ac-4e18-825f-6470467238b3"
              },
              {
                "reference": "urn:uuid:a54219b8-f741-4c47-b662-e4f8dfa49ab6"
              }
            ]
          }
        },
        {
          "fullUrl": "urn:uuid:a54219b8-f741-4c47-b662-e4f8dfa49ab6",
          "resource": {
            "resourceType": "MedicationRequest",
            "extension": [
              {
                "url": "https://fhir.nhs.uk/StructureDefinition/Extension-DM-PrescriptionType",
                "valueCoding": {
                  "system": "https://fhir.nhs.uk/CodeSystem/prescription-type",
                  "code": "0101",
                  "display": "Primary Care Prescriber - Medical Prescriber"
                }
              }
            ],
            "identifier": [
              {
                "system": "https://fhir.nhs.uk/Id/prescription-order-item-number",
                "value": "299c610b-f4f1-4eac-a7d7-4fb6b0556e11"
              }
            ],
            "status": "active",
            "intent": "order",
            "category": [
              {
                "coding": [
                  {
                    "system": "http://terminology.hl7.org/CodeSystem/medicationrequest-category",
                    "code": "community",
                    "display": "Community"
                  }
                ]
              }
            ],
            "medicationCodeableConcept": {
              "coding": [
                {
                  "system": "http://snomed.info/sct",
                  "code": "322237000",
                  "display": "Paracetamol 500mg soluble tablets"
                }
              ]
            },
            "subject": {
              "reference": "urn:uuid:78d3c2eb-009e-4ec8-a358-b042954aa9b2"
            },
            "authoredOn": "2021-05-07T14:47:29+00:00",
            "requester": {
              "reference": "urn:uuid:56166769-c1c4-4d07-afa8-132b5dfca666"
            },
            "groupIdentifier": {
              "extension": [
                {
                  "url": "https://fhir.nhs.uk/StructureDefinition/Extension-DM-PrescriptionId",
                  "valueIdentifier": {
                    "system": "https://fhir.nhs.uk/Id/prescription",
                    "value": "7fc6e3af-fb13-42e9-b6a0-d97bc3e6b76f"
                  }
                }
              ],
              "system": "https://fhir.nhs.uk/Id/prescription-order-number",
              "value": "EB8B1F-A83008-42DC8L"
            },
            "courseOfTherapyType": {
              "coding": [
                {
                  "system": "http://terminology.hl7.org/CodeSystem/medicationrequest-course-of-therapy",
                  "code": "acute",
                  "display": "Short course (acute) therapy"
                }
              ]
            },
            "dosageInstruction": [
              {
                "text": "One tablet to be taken four times a day",
                "timing": {
                  "repeat": {
                    "frequency": 4,
                    "period": 1,
                    "periodUnit": "d"
                  }
                },
                "route": {
                  "coding": [
                    {
                      "system": "http://snomed.info/sct",
                      "code": "26643006",
                      "display": "Oral"
                    }
                  ]
                }
              }
            ],
            "dispenseRequest": {
              "extension": [
                {
                  "url": "https://fhir.nhs.uk/StructureDefinition/Extension-DM-PerformerSiteType",
                  "valueCoding": {
                    "system": "https://fhir.nhs.uk/CodeSystem/dispensing-site-preference",
                    "code": "P1"
                  }
                }
              ],
              "validityPeriod": {
                "start": "2021-05-07",
                "end": "2021-06-04"
              },
              "expectedSupplyDuration": {
                "value": 30,
                "unit": "day",
                "system": "http://unitsofmeasure.org",
                "code": "d"
              },
              "performer": {
                "identifier": {
                  "system": "https://fhir.nhs.uk/Id/ods-organization-code",
                  "value": "FCG71"
                }
              },
              "quantity": {
                "value": 100,
                "unit": "tablet",
                "system": "http://snomed.info/sct",
                "code": "428673006"
              }
            },
            "substitution": {
              "allowedBoolean": false
            }
          }
        },
        {
          "fullUrl": "urn:uuid:5cb17f5a-11ac-4e18-825f-6470467238b3",
          "resource": {
            "resourceType": "MedicationRequest",
            "extension": [
              {
                "url": "https://fhir.nhs.uk/StructureDefinition/Extension-DM-PrescriptionType",
                "valueCoding": {
                  "system": "https://fhir.nhs.uk/CodeSystem/prescription-type",
                  "code": "0101",
                  "display": "Primary Care Prescriber - Medical Prescriber"
                }
              }
            ],
            "identifier": [
              {
                "system": "https://fhir.nhs.uk/Id/prescription-order-item-number",
                "value": "5cb17f5a-11ac-4e18-825f-6470467238b3"
              }
            ],
            "status": "active",
            "intent": "order",
            "category": [
              {
                "coding": [
                  {
                    "system": "http://terminology.hl7.org/CodeSystem/medicationrequest-category",
                    "code": "community",
                    "display": "Community"
                  }
                ]
              }
            ],
            "medicationCodeableConcept": {
              "coding": [
                {
                  "system": "http://snomed.info/sct",
                  "code": "39113611000001102",
                  "display": "Salbutamol 100micrograms/dose inhaler CFC free"
                }
              ]
            },
            "subject": {
              "reference": "urn:uuid:78d3c2eb-009e-4ec8-a358-b042954aa9b2"
            },
            "authoredOn": "2021-05-07T14:47:29+00:00",
            "requester": {
              "reference": "urn:uuid:56166769-c1c4-4d07-afa8-132b5dfca666"
            },
            "groupIdentifier": {
              "extension": [
                {
                  "url": "https://fhir.nhs.uk/StructureDefinition/Extension-DM-PrescriptionId",
                  "valueIdentifier": {
                    "system": "https://fhir.nhs.uk/Id/prescription",
                    "value": "7fc6e3af-fb13-42e9-b6a0-d97bc3e6b76f"
                  }
                }
              ],
              "system": "https://fhir.nhs.uk/Id/prescription-order-number",
              "value": "EB8B1F-A83008-42DC8L"
            },
            "courseOfTherapyType": {
              "coding": [
                {
                  "system": "http://terminology.hl7.org/CodeSystem/medicationrequest-course-of-therapy",
                  "code": "acute",
                  "display": "Short course (acute) therapy"
                }
              ]
            },
            "dosageInstruction": [
              {
                "text": "One dose to be taken five times a day",
                "timing": {
                  "repeat": {
                    "frequency": 5,
                    "period": 1,
                    "periodUnit": "d"
                  }
                },
                "route": {
                  "coding": [
                    {
                      "system": "http://snomed.info/sct",
                      "code": "18679011000001101",
                      "display": "Inhalation"
                    }
                  ]
                }
              }
            ],
            "dispenseRequest": {
              "extension": [
                {
                  "url": "https://fhir.nhs.uk/StructureDefinition/Extension-DM-PerformerSiteType",
                  "valueCoding": {
                    "system": "https://fhir.nhs.uk/CodeSystem/dispensing-site-preference",
                    "code": "P1"
                  }
                }
              ],
              "validityPeriod": {
                "start": "2021-05-07",
                "end": "2021-06-04"
              },
              "expectedSupplyDuration": {
                "value": 30,
                "unit": "day",
                "system": "http://unitsofmeasure.org",
                "code": "d"
              },
              "performer": {
                "identifier": {
                  "system": "https://fhir.nhs.uk/Id/ods-organization-code",
                  "value": "FCG71"
                }
              },
              "quantity": {
                "value": 200,
                "unit": "dose",
                "system": "http://snomed.info/sct",
                "code": "3317411000001100"
              }
            },
            "substitution": {
              "allowedBoolean": false
            }
          }
        },
        {
          "fullUrl": "urn:uuid:78d3c2eb-009e-4ec8-a358-b042954aa9b2",
          "resource": {
            "resourceType": "Patient",
            "identifier": [
              {
                "extension": [
                  {
                    "url": "https://fhir.hl7.org.uk/StructureDefinition/Extension-UKCore-NHSNumberVerificationStatus",
                    "valueCodeableConcept": {
                      "coding": [
                        {
                          "system": "https://fhir.hl7.org.uk/CodeSystem/UKCore-NHSNumberVerificationStatus",
                          "code": "01",
                          "display": "Number present and verified"
                        }
                      ]
                    }
                  }
                ],
                "system": "https://fhir.nhs.uk/Id/nhs-number",
                "value": "9990548609"
              }
            ],
            "name": [
              {
                "use": "usual",
                "family": "XXTESTPATIENT-TGNP",
                "given": [
                  "DONOTUSE"
                ],
                "prefix": [
                  "MR"
                ]
              }
            ],
            "gender": "male",
            "birthDate": "1932-01-06",
            "address": [
              {
                "use": "home",
                "line": [
                  "1 Trevelyan Square",
                  "Boar Lane",
                  "Leeds",
                  "West Yorkshire"
                ],
                "postalCode": "LS1 6AE"
              }
            ],
            "generalPractitioner": [
              {
                "identifier": {
                  "system": "https://fhir.nhs.uk/Id/ods-organization-code",
                  "value": "A83008"
                }
              }
            ]
          }
        },
        {
          "fullUrl": "urn:uuid:56166769-c1c4-4d07-afa8-132b5dfca666",
          "resource": {
            "resourceType": "PractitionerRole",
            "identifier": [
              {
                "system": "https://fhir.nhs.uk/Id/sds-role-profile-id",
                "value": "200102238987"
              }
            ],
            "practitioner": {
              "reference": "urn:uuid:a8c85454-f8cb-498d-9629-78e2cb5fa47a"
            },
            "organization": {
              "reference": "urn:uuid:3b4b03a5-52ba-4ba6-9b82-70350aa109d8"
            },
        "code": [
              {
                "coding": [
                  {
                    "system": "https://fhir.hl7.org.uk/CodeSystem/UKCore-SDSJobRoleName",
                    "code": "R8000",
                    "display": "Clinical Practitioner Access Role"
                  }
                ]
              }
            ],
            "telecom": [
              {
                "system": "phone",
                "value": "01234567890",
                "use": "work"
              }
            ]
          }
        },
        {
          "fullUrl": "urn:uuid:a8c85454-f8cb-498d-9629-78e2cb5fa47a",
          "resource": {
            "resourceType": "Practitioner",
            "identifier": [
              {
                "system": "https://fhir.nhs.uk/Id/sds-user-id",
                "value": "555086689106"
              },
              {
                "system": "https://fhir.hl7.org.uk/Id/gmc-number",
                "value": "6095103"
              },
              {
                "system": "https://fhir.hl7.org.uk/Id/din-number",
                "value": "977677"
              }
            ],
            "name": [
              {
                "family": "BOIN",
                "given": [
                  "C"
                ],
                "prefix": [
                  "DR"
                ]
              }
            ]
          }
        },
        {
          "fullUrl": "urn:uuid:3b4b03a5-52ba-4ba6-9b82-70350aa109d8",
          "resource": {
            "resourceType": "Organization",
            "identifier": [
              {
                "system": "https://fhir.nhs.uk/Id/ods-organization-code",
                "value": "A83008"
              }
            ],
            "type": [
              {
                "coding": [
                  {
                    "system": "https://fhir.nhs.uk/CodeSystem/organisation-role",
                    "code": "76",
                    "display": "GP PRACTICE"
                  }
                ]
              }
            ],
            "name": "HALLGARTH SURGERY",
            "address": [
              {
                "use": "work",
                "type": "both",
                "line": [
                  "HALLGARTH SURGERY",
                  "CHEAPSIDE"
                ],
                "city": "SHILDON",
                "district": "COUNTY DURHAM",
                "postalCode": "DL4 2HP"
              }
            ],
            "telecom": [
              {
                "system": "phone",
                "value": "0115 9737320",
                "use": "work"
              }
            ],
            "partOf": {
              "identifier": {
                "system": "https://fhir.nhs.uk/Id/ods-organization-code",
                "value": "84H"
              },
              "display": "NHS COUNTY DURHAM CCG"
            }
          }
        }
  ]
}
```
